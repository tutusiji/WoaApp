# 数据模型接口

<cite>
**本文档引用的文件**
- [src/main/todo.ts](file://src/main/todo.ts)
- [src/preload/index.d.ts](file://src/preload/index.d.ts)
- [src/renderer/src/components/Todo.vue](file://src/renderer/src/components/Todo.vue)
- [src/renderer/src/env.d.ts](file://src/renderer/src/env.d.ts)
- [temp_eSearch/src/ShareTypes.d.ts](file://temp_eSearch/src/ShareTypes.d.ts)
- [temp_eSearch/lib/store/store.ts](file://temp_eSearch/lib/store/store.ts)
- [temp_eSearch/lib/store/renderStore.ts](file://temp_eSearch/lib/store/renderStore.ts)
- [temp_eSearch/src/main/main.ts](file://temp_eSearch/src/main/main.ts)
- [README.md](file://README.md)
- [ARCHITECTURE.md](file://ARCHITECTURE.md)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心数据模型](#核心数据模型)
4. [架构概览](#架构概览)
5. [详细组件分析](#详细组件分析)
6. [依赖关系分析](#依赖关系分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 简介

本文档详细记录了WoaApp项目中的数据模型接口，重点关注在API之间传递的核心数据结构。项目采用Electron框架构建，包含主进程、预加载脚本和渲染进程三个主要部分。数据模型主要涉及待办事项管理、设置配置以及消息处理等核心功能。

项目通过IPC（Inter-Process Communication）机制实现进程间通信，确保数据在不同进程间的正确传递和同步。数据模型的设计遵循类型安全原则，使用TypeScript接口定义确保编译时类型检查。

## 项目结构

项目采用典型的Electron应用结构，分为以下主要模块：

```mermaid
graph TB
subgraph "主进程 (Main Process)"
MP1[src/main/todo.ts]
MP2[temp_eSearch/src/main/main.ts]
MP3[src/main/websocket-monitor.ts]
end
subgraph "预加载脚本 (Preload)"
PL1[src/preload/index.d.ts]
end
subgraph "渲染进程 (Renderer)"
RP1[src/renderer/src/components/Todo.vue]
RP2[src/renderer/src/env.d.ts]
RP3[src/renderer/src/types/global.d.ts]
end
subgraph "共享类型定义"
ST1[temp_eSearch/src/ShareTypes.d.ts]
ST2[temp_eSearch/lib/store/store.ts]
ST3[temp_eSearch/lib/store/renderStore.ts]
end
MP1 --> PL1
PL1 --> RP1
MP2 --> ST2
ST2 --> ST3
ST1 --> RP2
```

**图表来源**
- [src/main/todo.ts](file://src/main/todo.ts#L1-L266)
- [src/preload/index.d.ts](file://src/preload/index.d.ts#L1-L23)
- [src/renderer/src/components/Todo.vue](file://src/renderer/src/components/Todo.vue#L1-L281)

**章节来源**
- [src/main/todo.ts](file://src/main/todo.ts#L1-L266)
- [src/preload/index.d.ts](file://src/preload/index.d.ts#L1-L23)
- [src/renderer/src/components/Todo.vue](file://src/renderer/src/components/Todo.vue#L1-L281)

## 核心数据模型

### TodoItem 数据模型

TodoItem是待办事项管理的核心数据结构，定义了完整的待办事项信息。

```mermaid
classDiagram
class TodoItem {
+string id
+string title
+string details
+number timestamp
+string source
+boolean processed
}
class TodoManager {
-BrowserWindow todoWindow
-any store
+constructor()
+createTodoWindow() void
+registerIpcHandlers() void
+getUnprocessedTodoCount() number
+broadcastTodoCountUpdate() void
+getInjectScript() string
}
TodoManager --> TodoItem : "管理"
```

**图表来源**
- [src/main/todo.ts](file://src/main/todo.ts#L7-L14)
- [src/main/todo.ts](file://src/main/todo.ts#L20-L33)

#### 字段详细说明

| 字段名 | 类型 | 必填 | 默认值 | 业务含义 | 取值范围/约束 |
|--------|------|------|--------|----------|---------------|
| id | string | 是 | - | 待办事项唯一标识符 | 格式: "todo-{timestamp}" |
| title | string | 是 | - | 待办事项标题 | 非空字符串，长度限制由前端验证 |
| details | string | 是 | - | 待办事项详细描述 | 可为空字符串，支持多行文本 |
| timestamp | number | 是 | - | 创建时间戳 | Unix毫秒时间戳，自动生成 |
| source | string | 是 | "手动新增" | 数据来源标识 | "手动新增" \| "聊天记录" \| 自定义来源 |
| processed | boolean | 是 | false | 处理状态标记 | true/false |

#### 数据验证规则

1. **必填字段验证**: 所有字段均为必填，特别是id、title、details、timestamp、source、processed
2. **类型验证**: 
   - id必须为字符串且符合"todo-{timestamp}"格式
   - timestamp必须为数字类型
   - processed必须为布尔类型
3. **业务逻辑验证**:
   - id自动生成，不允许外部传入
   - timestamp自动生成，表示创建时间
   - source字段限制特定值集合

**章节来源**
- [src/main/todo.ts](file://src/main/todo.ts#L7-L14)
- [src/main/todo.ts](file://src/main/todo.ts#L87-L99)

### IPC API 接口定义

项目通过预加载脚本暴露统一的API接口给渲染进程使用。

```mermaid
sequenceDiagram
participant Renderer as 渲染进程
participant Preload as 预加载脚本
participant Main as 主进程
participant Store as 存储
Renderer->>Preload : window.api.getTodos()
Preload->>Main : ipcRenderer.invoke('get-todos')
Main->>Store : store.get('todos')
Store-->>Main : TodoItem[]
Main-->>Preload : TodoItem[]
Preload-->>Renderer : Promise<TodoItem[]>
Note over Renderer,Store : 数据序列化/反序列化过程
```

**图表来源**
- [src/preload/index.d.ts](file://src/preload/index.d.ts#L7-L20)
- [src/main/todo.ts](file://src/main/todo.ts#L82-L84)

#### API 方法定义

| 方法名 | 参数类型 | 返回类型 | 业务用途 |
|--------|----------|----------|----------|
| getTodos | - | Promise<TodoItem[]> | 获取所有待办事项 |
| addTodo | Omit<TodoItem, 'id' \| 'timestamp' \| 'processed'> | Promise<TodoItem> | 新增待办事项 |
| updateTodo | TodoItem | Promise<TodoItem> | 更新待办事项 |
| deleteTodo | string | Promise<boolean> | 删除待办事项 |
| getUnprocessedTodoCount | - | Promise<number> | 获取未处理事项数量 |

**章节来源**
- [src/preload/index.d.ts](file://src/preload/index.d.ts#L7-L20)
- [src/main/todo.ts](file://src/main/todo.ts#L82-L122)

### 设置配置数据模型

项目使用复杂的设置配置系统，支持多种功能的配置管理。

```mermaid
erDiagram
setting {
boolean 首次运行
string 设置版本
boolean 启动提示
boolean dev
json 语言
string 托盘
boolean 保留截屏窗口
json 快捷键
boolean 点击托盘自动截图
json 全局工具快捷键
json 工具快捷键
json 截屏编辑快捷键
json 鼠标快捷键
json 大小栏快捷键
json 主页面快捷键
json 其他快捷键
json 主搜索功能
json 全局
json 工具栏
json 字体
json 编辑器
string 工具栏跟随
boolean 自动搜索
json 取色器
json 鼠标跟随栏
boolean 显示四角坐标
json 框选
json 图像编辑
json OCR
json 离线OCR
json AI
json 在线OCR
json 以图搜图
boolean 自动打开链接
number 自动搜索中文占比
boolean 浏览器中打开
json 浏览器
json 保存
json 保存名称
string 框选后默认操作
json 快速截屏
json 引擎
json 历史记录设置
array ding_dock
json 贴图
json 代理
json 主页面
array 主页面大小
string 时间格式
boolean 硬件加速
json 更新
json 录屏
json 屏幕翻译
json 翻译
json 额外截屏器
json 连拍
json 广截屏
json 高级图片编辑
json 网络
}
```

**图表来源**
- [temp_eSearch/src/ShareTypes.d.ts](file://temp_eSearch/src/ShareTypes.d.ts#L1-L417)

**章节来源**
- [temp_eSearch/src/ShareTypes.d.ts](file://temp_eSearch/src/ShareTypes.d.ts#L1-L417)

## 架构概览

项目采用分层架构设计，通过IPC机制实现进程间通信：

```mermaid
graph TB
subgraph "用户界面层"
UI1[Todo.vue]
UI2[Versions.vue]
UI3[Update.vue]
end
subgraph "预加载层"
PL1[window.api接口]
PL2[类型定义]
end
subgraph "主进程层"
MP1[TodoManager类]
MP2[IPC处理器]
MP3[数据存储]
end
subgraph "数据持久化"
DS1[electron-store]
DS2[config.json]
end
UI1 --> PL1
PL1 --> MP1
MP1 --> MP2
MP2 --> DS1
DS1 --> DS2
```

**图表来源**
- [src/renderer/src/components/Todo.vue](file://src/renderer/src/components/Todo.vue#L56-L150)
- [src/preload/index.d.ts](file://src/preload/index.d.ts#L7-L20)
- [src/main/todo.ts](file://src/main/todo.ts#L20-L33)

**章节来源**
- [README.md](file://README.md#L272-L315)
- [ARCHITECTURE.md](file://ARCHITECTURE.md#L272-L315)

## 详细组件分析

### TodoManager 类分析

TodoManager是待办事项管理的核心类，负责处理所有待办事项相关的业务逻辑。

```mermaid
classDiagram
class TodoManager {
-BrowserWindow todoWindow
-any store
+constructor()
+createTodoWindow() void
+registerIpcHandlers() void
+getUnprocessedTodoCount() number
+broadcastTodoCountUpdate() void
+getInjectScript() string
}
class TodoItem {
+string id
+string title
+string details
+number timestamp
+string source
+boolean processed
}
TodoManager --> TodoItem : "管理待办事项"
```

**图表来源**
- [src/main/todo.ts](file://src/main/todo.ts#L20-L33)
- [src/main/todo.ts](file://src/main/todo.ts#L7-L14)

#### 核心方法流程

**添加待办事项流程**:

```mermaid
flowchart TD
Start([开始添加待办事项]) --> Validate["验证输入参数"]
Validate --> GetStore["获取现有待办事项"]
GetStore --> CreateNew["创建新待办事项对象"]
CreateNew --> SetFields["设置id、timestamp、processed字段"]
SetFields --> UpdateList["更新待办事项列表"]
UpdateList --> SaveStore["保存到存储"]
SaveStore --> Broadcast["广播数量更新"]
Broadcast --> Return["返回新待办事项"]
Return --> End([结束])
```

**图表来源**
- [src/main/todo.ts](file://src/main/todo.ts#L87-L99)

**章节来源**
- [src/main/todo.ts](file://src/main/todo.ts#L20-L154)

### IPC 通信机制

项目使用Electron的IPC机制实现进程间通信，确保数据在不同进程间的正确传递。

```mermaid
sequenceDiagram
participant UI as 用户界面
participant API as window.api
participant IPC as IPC通道
participant Handler as IPC处理器
participant Store as 数据存储
UI->>API : 调用API方法
API->>IPC : 发送IPC消息
IPC->>Handler : 调用对应处理器
Handler->>Store : 访问数据存储
Store-->>Handler : 返回数据
Handler-->>IPC : 返回处理结果
IPC-->>API : 返回响应
API-->>UI : Promise结果
```

**图表来源**
- [src/preload/index.d.ts](file://src/preload/index.d.ts#L7-L20)
- [src/main/todo.ts](file://src/main/todo.ts#L77-L136)

**章节来源**
- [src/preload/index.d.ts](file://src/preload/index.d.ts#L1-L23)
- [src/main/todo.ts](file://src/main/todo.ts#L77-L136)

### 数据存储策略

项目采用两种主要的数据存储方式：

1. **electron-store**: 用于待办事项等临时数据存储
2. **JSON文件**: 用于复杂设置配置的持久化存储

```mermaid
flowchart LR
subgraph "存储层"
ES[electron-store]
FS[文件系统]
end
subgraph "应用层"
TM[TodoManager]
ST[设置存储]
end
TM --> ES
ST --> FS
ES --> FS
```

**图表来源**
- [src/main/todo.ts](file://src/main/todo.ts#L26-L31)
- [temp_eSearch/lib/store/store.ts](file://temp_eSearch/lib/store/store.ts#L14-L45)

**章节来源**
- [src/main/todo.ts](file://src/main/todo.ts#L26-L31)
- [temp_eSearch/lib/store/store.ts](file://temp_eSearch/lib/store/store.ts#L14-L72)

## 依赖关系分析

项目各组件间的依赖关系如下：

```mermaid
graph TB
subgraph "核心依赖"
TS[TypeScript]
Electron[Electron]
Vue[Vue.js]
end
subgraph "项目组件"
TodoTS[src/main/todo.ts]
PreloadTS[src/preload/index.d.ts]
TodoVue[src/renderer/src/components/Todo.vue]
ShareTypes[temp_eSearch/src/ShareTypes.d.ts]
end
subgraph "第三方库"
Store[electron-store]
Utils[@electron-toolkit/utils]
end
TodoTS --> Store
TodoTS --> Utils
TodoVue --> TS
TodoTS --> Electron
PreloadTS --> Electron
ShareTypes --> TS
```

**图表来源**
- [src/main/todo.ts](file://src/main/todo.ts#L1-L4)
- [src/preload/index.d.ts](file://src/preload/index.d.ts#L1-L2)
- [temp_eSearch/src/ShareTypes.d.ts](file://temp_eSearch/src/ShareTypes.d.ts#L1-L559)

**章节来源**
- [src/main/todo.ts](file://src/main/todo.ts#L1-L4)
- [src/preload/index.d.ts](file://src/preload/index.d.ts#L1-L2)
- [temp_eSearch/src/ShareTypes.d.ts](file://temp_eSearch/src/ShareTypes.d.ts#L1-L559)

## 性能考虑

### 数据访问优化

1. **内存缓存**: TodoManager维护内存中的待办事项列表，减少磁盘I/O操作
2. **批量操作**: 支持批量更新和删除操作，提高性能
3. **懒加载**: 待办事项窗口按需创建，避免不必要的资源消耗

### 序列化性能

1. **JSON序列化**: 使用原生JSON序列化，性能优异
2. **类型安全**: 通过TypeScript确保序列化数据的类型正确性
3. **最小化传输**: 仅传输必要的字段，减少IPC通信开销

## 故障排除指南

### 常见问题及解决方案

**问题1: IPC通信失败**
- 检查预加载脚本是否正确初始化
- 验证IPC事件名称是否匹配
- 确认主进程是否正确注册了处理器

**问题2: 数据不一致**
- 检查存储层的事务处理
- 验证并发访问的同步机制
- 确认数据验证规则是否正确执行

**问题3: 内存泄漏**
- 检查事件监听器的清理
- 验证窗口对象的正确销毁
- 确认存储引用的及时释放

**章节来源**
- [src/main/todo.ts](file://src/main/todo.ts#L38-L72)
- [src/preload/index.d.ts](file://src/preload/index.d.ts#L4-L22)

## 结论

WoaApp项目的数据模型接口设计体现了现代Electron应用的最佳实践。通过清晰的类型定义、严格的验证规则和高效的IPC通信机制，实现了可靠的数据管理功能。

核心优势包括：
1. **类型安全**: 完整的TypeScript类型定义确保编译时错误检测
2. **架构清晰**: 分层设计便于维护和扩展
3. **性能优化**: 合理的存储策略和通信机制
4. **可扩展性**: 模块化的组件设计支持功能扩展

未来改进建议：
1. 实现更完善的数据验证机制
2. 添加数据迁移和版本兼容性支持
3. 增强错误处理和日志记录功能
4. 优化大数据量场景下的性能表现